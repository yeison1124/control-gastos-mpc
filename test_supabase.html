<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Prueba de Conexi√≥n Supabase</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/config.js"></script>
</head>

<body class="p-5">
    <div class="container">
        <h1>Diagn√≥stico de Supabase</h1>

        <div class="row">
            <div class="col-md-6">
                <div class="card p-3 my-3">
                    <h3>1. Prueba de Registro Autom√°tico</h3>
                    <button onclick="testConnection()" class="btn btn-primary">Ejecutar Diagn√≥stico Completo</button>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card p-3 my-3">
                    <h3>2. Prueba Manual</h3>
                    <div class="mb-3">
                        <label>Email:</label>
                        <input type="email" id="testEmail" class="form-control" placeholder="test@ejemplo.com">
                    </div>
                    <div class="mb-3">
                        <label>Contrase√±a:</label>
                        <input type="text" id="testPass" class="form-control" placeholder="123456 (visible)">
                    </div>
                    <div class="d-flex gap-2">
                        <button onclick="testRegister()" class="btn btn-warning">1. Registrar</button>
                        <button onclick="testLogin()" class="btn btn-success">2. Loguear</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card p-3 my-3 bg-dark text-white">
            <h3>LOGS DEL SISTEMA:</h3>
            <pre id="log" class="p-3 border" style="min-height: 200px; color: #0f0; font-family: monospace;"></pre>
        </div>

        <a href="index.html" class="btn btn-secondary">Volver al Inicio</a>
    </div>

    <script>
        function log(msg, type = 'info') {
            const logEl = document.getElementById('log');
            logEl.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            console.log(msg);
        }

        async function testRegister() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPass').value;

            if (!email || !password) return alert("Escribe email y contrase√±a");

            log(`\n--- INTENTANDO REGISTRO MANUAL: ${email} ---`);

            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password,
                options: { data: { full_name: "Usuario Test Manual" } }
            });

            if (error) {
                log(`‚ùå ERROR REGISTRO: ${error.message}`);
                console.error(error);
                if (error.message.includes("User already registered")) {
                    log("‚ö†Ô∏è EL USUARIO YA EXISTE.");
                    log("üëâ Ve a Supabase -> Auth -> Users y BORRALO para reintentar.");
                }
            } else {
                log("‚úÖ ¬°REGISTRO ENVIADO!");
                if (data.user && !data.session) {
                    log("‚ö†Ô∏è El usuario se cre√≥ pero requiere confirmaci√≥n de email.");
                } else if (data.session) {
                    log("‚úÖ Usuario creado y sesi√≥n activa.");
                }
            }
        }

        async function testLogin() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPass').value;

            if (!email || !password) return alert("Escribe email y contrase√±a");

            log(`\n--- INTENTANDO LOGIN MANUAL: ${email} ---`);

            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) {
                log(`‚ùå ERROR DE LOGIN: ${error.message}`);
                console.error(error);
                if (error.message.includes("Invalid login credentials")) {
                    log("üëâ Esto significa correo o contrase√±a incorrectos.");
                    log("üëâ O el email no ha sido confirmado si 'Confirm Email' est√° activo.");
                }
            } else {
                log("‚úÖ ¬°LOGIN EXITOSO!");
                log(`Usuario ID: ${data.user.id}`);
                log(`Email: ${data.user.email}`);
                alert("¬°FUNCIONA! Las credenciales son correctas.");
            }
        }

        async function testConnection() {
            const statusEl = document.getElementById('status');
            statusEl.innerText = "Conectando...";
            statusEl.className = "text-warning";
            document.getElementById('log').innerText = "";

            try {
                log("1. Verificando configuraci√≥n...");
                if (!supabase) throw new Error("Cliente Supabase no inicializado");
                log("Configuraci√≥n OK.");

                log("2. Probando conexi√≥n b√°sica (Health check)...");
                // Intentamos leer la tabla profiles (aunque est√© vac√≠a, si da error de perm es conexi√≥n)
                const { data: profiles, error: selectError } = await supabase.from('profiles').select('count', { count: 'exact', head: true });

                if (selectError) {
                    log("Advertencia en lectura (normal si RLS est√° activo y no hay sesi√≥n): " + selectError.message);
                } else {
                    log("Conexi√≥n de lectura OK.");
                }

                log("3. Intentando registrar usuario de prueba...");
                const email = `test_${Date.now()}@prueba.com`;
                const password = "Password123!";

                log(`Registrando: ${email}`);

                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: { full_name: "Usuario de Prueba" }
                    }
                });

                if (error) {
                    throw error;
                }

                if (data.user) {
                    log("‚úÖ USUARIO CREADO CON √âXITO");
                    log("ID: " + data.user.id);
                    statusEl.innerText = "¬°SISTEMA FUNCIONANDO!";
                    statusEl.className = "text-success fw-bold";

                    if (data.session) {
                        log("‚úÖ Sesi√≥n iniciada autom√°ticamente.");
                    } else {
                        log("‚ö†Ô∏è Usuario creado pero SIN sesi√≥n (Probablemente requiere Confirmaci√≥n de Email).");
                        log("SOLUCI√ìN: Ve a Supabase -> Auth -> Providers -> Email -> Desactiva 'Confirm Email'.");
                    }
                }

            } catch (err) {
                statusEl.innerText = "FALL√ì";
                statusEl.className = "text-danger fw-bold";
                log("‚ùå ERROR FATAL: " + (err.message || JSON.stringify(err)));

                if (err.message && err.message.includes("search_path")) {
                    log("\nüëâ CAUSA: Error de seguridad en la Base de Datos.");
                    log("SOLUCI√ìN: Ejecuta el script db/reset_auth_schema.sql en Supabase.");
                }
            }
        }

        // Ejecutar al inicio
        testConnection();
    </script>
</body>

</html>