<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” DIAGNÃ“STICO - Sistema de Registro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
            line-height: 1.6;
        }

        h1,
        h2,
        h3 {
            color: #fff;
            margin: 20px 0 10px 0;
            border-bottom: 2px solid #0f0;
            padding-bottom: 5px;
        }

        .success {
            color: #0f0;
            font-weight: bold;
        }

        .error {
            color: #f00;
            font-weight: bold;
        }

        .warning {
            color: #fa0;
            font-weight: bold;
        }

        .info {
            color: #0af;
        }

        pre {
            background: #111;
            padding: 10px;
            overflow-x: auto;
            border-left: 3px solid #0f0;
            margin: 10px 0;
        }

        .test-box {
            border: 1px solid #333;
            padding: 15px;
            margin: 15px 0;
            background: #0a0a0a;
        }

        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            border-radius: 5px;
        }

        button:hover {
            background: #0c0;
        }

        button:active {
            background: #090;
        }

        #output {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>ğŸ” DIAGNÃ“STICO DEL SISTEMA DE REGISTRO</h1>
    <p class="info">
        âš¡ Este script probarÃ¡ cada componente del registro.<br>
        ğŸ“‹ Los resultados aparecerÃ¡n abajo y en la Console (F12)
    </p>

    <div style="margin: 20px 0;">
        <button onclick="runTests()" style="font-size: 20px;">â–¶ï¸ EJECUTAR DIAGNÃ“STICO</button>
        <button onclick="testRealRegistration()">ğŸ“ PROBAR REGISTRO REAL</button>
        <button onclick="clearOutput()">ğŸ—‘ï¸ LIMPIAR</button>
    </div>

    <div id="output"></div>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // CONFIGURACIÃ“N
        const SUPABASE_URL = 'https://zczvobqrmucwrbrlksye.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjenZvYnFybXVjd3Jicmxrc3llIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTcyMjAsImV4cCI6MjA4MDYzMzIyMH0.AhRbPtGRUlvW5_Yj-CTKhMFp0w1BvSIUVAO2ucFKbuM';

        let supabase = null;
        const output = document.getElementById('output');

        // UTILIDADES
        function print(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-box ${type}`;
            div.innerHTML = msg;
            output.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${msg.replace(/<[^>]*>/g, '')}`);
            window.scrollTo(0, document.body.scrollHeight);
        }

        function clearOutput() {
            output.innerHTML = '';
            console.clear();
        }

        // TESTS
        async function test1() {
            print('<h3>ğŸ§ª TEST #1: Verificando CDN de Supabase</h3>');

            if (typeof window.supabase === 'undefined') {
                print('âŒ ERROR: window.supabase no estÃ¡ definido<br>El CDN de Supabase no cargÃ³ correctamente.', 'error');
                return false;
            }

            print('âœ… window.supabase estÃ¡ definido', 'success');

            if (typeof window.supabase.createClient !== 'function') {
                print('âŒ ERROR: createClient no es una funciÃ³n', 'error');
                return false;
            }

            print('âœ… createClient estÃ¡ disponible', 'success');
            return true;
        }

        async function test2() {
            print('<h3>ğŸ§ª TEST #2: Inicializando Cliente Supabase</h3>');

            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                print('âœ… Cliente Supabase creado exitosamente', 'success');
                print(`ğŸ“ URL: ${SUPABASE_URL}`, 'info');
                return true;
            } catch (error) {
                print(`âŒ ERROR: ${error.message}`, 'error');
                print(`<pre>${JSON.stringify(error, null, 2)}</pre>`, 'error');
                return false;
            }
        }

        async function test3() {
            print('<h3>ğŸ§ª TEST #3: Probando ConexiÃ³n con Supabase</h3>');

            try {
                const { data, error } = await supabase.auth.getSession();

                if (error) {
                    print(`âš ï¸ WARNING: ${error.message}`, 'warning');
                } else {
                    print('âœ… ConexiÃ³n establecida con Supabase Auth', 'success');
                    print(`ğŸ“Š Session activa: ${data.session ? 'SÃ' : 'NO'}`, 'info');
                }
                return true;
            } catch (error) {
                print(`âŒ ERROR de conexiÃ³n: ${error.message}`, 'error');
                return false;
            }
        }

        async function test4() {
            print('<h3>ğŸ§ª TEST #4: Probando SignUp (CRÃTICO)</h3>');

            const testEmail = `test_${Date.now()}@diagnostico.test`;
            const testPassword = 'Test123456789';

            print(`ğŸ“§ Email de prueba: ${testEmail}`, 'info');
            print(`ğŸ”‘ Password: ${testPassword}`, 'info');
            print('â³ Intentando registrar...', 'info');

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: testEmail,
                    password: testPassword,
                    options: {
                        data: {
                            full_name: 'Usuario de Prueba DiagnÃ³stico'
                        }
                    }
                });

                if (error) {
                    print(`<h2>âŒ ERROR EN SIGNUP</h2>`, 'error');
                    print(`Mensaje: ${error.message}`, 'error');
                    print(`Status: ${error.status || 'N/A'}`, 'error');
                    print(`Code: ${error.code || 'N/A'}`, 'error');
                    print(`<pre>${JSON.stringify(error, null, 2)}</pre>`, 'error');

                    print('<h3>ğŸ’¡ POSIBLES SOLUCIONES:</h3>', 'warning');

                    if (error.message.includes('Email') || error.message.includes('email')) {
                        print('ğŸ”§ Verifica que "Enable email confirmations" estÃ© DESMARCADO en Supabase', 'warning');
                    }
                    if (error.message.includes('confirm') || error.message.includes('verification')) {
                        print('ğŸ”§ Desactiva la confirmaciÃ³n de email en: Authentication â†’ Settings', 'warning');
                    }
                    if (error.status === 400 || error.status === 422) {
                        print('ğŸ”§ Revisa la configuraciÃ³n de Auth en Supabase Dashboard', 'warning');
                    }

                    return false;
                }

                print('<h2>âœ… Â¡SIGNUP EXITOSO!</h2>', 'success');
                print(`ğŸ‘¤ User ID: ${data.user?.id}`, 'success');
                print(`ğŸ“§ Email: ${data.user?.email}`, 'success');
                print(`âœ”ï¸ Email confirmado: ${data.user?.confirmed_at ? 'SÃ' : 'NO'}`, 'info');
                print(`ğŸ« Session creada: ${data.session ? 'SÃ âœ…' : 'NO âŒ'}`, data.session ? 'success' : 'warning');

                if (data.user?.identities) {
                    print(`ğŸ” Identities: ${data.user.identities.length}`, 'info');
                }

                print(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'info');

                // Cerrar sesiÃ³n
                await supabase.auth.signOut();
                print('âœ… SignOut exitoso - usuario de prueba eliminado', 'success');

                return true;
            } catch (error) {
                print(`âŒ EXCEPTION: ${error.message}`, 'error');
                print(`<pre>${JSON.stringify(error, null, 2)}</pre>`, 'error');
                return false;
            }
        }

        async function test5() {
            print('<h3>ğŸ§ª TEST #5: Verificando Tabla Profiles</h3>');

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .limit(1);

                if (error) {
                    if (error.code === '42P01') {
                        print('âš ï¸ Tabla "profiles" NO EXISTE', 'warning');
                        print('ğŸ”§ SoluciÃ³n: Ejecuta db/complete_db_setup.sql en Supabase SQL Editor', 'warning');
                    } else {
                        print(`âš ï¸ Error: ${error.message} (${error.code})`, 'warning');
                    }
                } else {
                    print('âœ… Tabla "profiles" existe y es accesible', 'success');
                    print(`ğŸ“Š Registros encontrados: ${data?.length || 0}`, 'info');
                }
            } catch (error) {
                print(`âŒ ERROR: ${error.message}`, 'error');
            }
        }

        async function testRealRegistration() {
            if (!supabase) {
                print('âŒ Primero ejecuta el diagnÃ³stico completo', 'error');
                return;
            }

            print('<h2>ğŸ“ REGISTRO REAL</h2>');

            const email = prompt('Ingresa tu EMAIL:');
            if (!email) {
                print('âŒ Cancelado', 'error');
                return;
            }

            const password = prompt('Ingresa tu PASSWORD (mÃ­nimo 6 caracteres):');
            if (!password || password.length < 6) {
                print('âŒ Password invÃ¡lido (mÃ­nimo 6 caracteres)', 'error');
                return;
            }

            const fullName = prompt('Ingresa tu NOMBRE COMPLETO:');
            if (!fullName) {
                print('âŒ Cancelado', 'error');
                return;
            }

            print(`ğŸ“§ Intentando registrar: ${email}`, 'info');

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: fullName
                        },
                        emailRedirectTo: window.location.origin + '/dashboard.html'
                    }
                });

                if (error) {
                    print(`<h2>âŒ ERROR EN REGISTRO</h2>`, 'error');
                    print(`${error.message}`, 'error');
                    print(`<pre>${JSON.stringify(error, null, 2)}</pre>`, 'error');
                    return;
                }

                print('<h2>âœ… Â¡REGISTRO EXITOSO!</h2>', 'success');
                print(`User: ${data.user?.email}`, 'success');
                print(`ID: ${data.user?.id}`, 'success');

                if (data.session) {
                    print('âœ… Session creada - Redirigiendo a dashboard...', 'success');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                } else {
                    print('âš ï¸ No hay session - Revisa tu email para confirmar', 'warning');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                }
            } catch (error) {
                print(`âŒ EXCEPTION: ${error.message}`, 'error');
                print(`<pre>${JSON.stringify(error, null, 2)}</pre>`, 'error');
            }
        }

        // EJECUTAR TODOS LOS TESTS
        async function runTests() {
            clearOutput();
            print('<h1>ğŸš€ INICIANDO DIAGNÃ“STICO COMPLETO</h1>');
            print(`ğŸ“… ${new Date().toLocaleString()}`, 'info');
            print('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');

            const t1 = await test1();
            if (!t1) {
                print('<h2>ğŸ›‘ TESTS DETENIDOS</h2>', 'error');
                print('El CDN de Supabase no cargÃ³. Verifica tu conexiÃ³n a internet.', 'error');
                return;
            }

            const t2 = await test2();
            if (!t2) {
                print('<h2>ğŸ›‘ TESTS DETENIDOS</h2>', 'error');
                print('No se pudo crear el cliente Supabase. Verifica las credenciales.', 'error');
                return;
            }

            await test3();
            await test4(); // Este es el mÃ¡s importante
            await test5();

            print('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            print('<h2>âœ… DIAGNÃ“STICO COMPLETADO</h2>', 'success');
            print('<p class="warning">Revisa los resultados arriba, especialmente el TEST #4 que es el CRÃTICO.</p>');
        }

        // AUTO-EJECUTAR mensaje de bienvenida
        window.addEventListener('load', () => {
            print('<p class="success">âœ… PÃ¡gina cargada correctamente.</p>');
            print('<p class="info">ğŸ‘† Haz click en "EJECUTAR DIAGNÃ“STICO" para comenzar.</p>');
            console.log('ğŸ” DiagnÃ³stico listo. Presiona el botÃ³n para ejecutar.');
        });
    </script>
</body>

</html>