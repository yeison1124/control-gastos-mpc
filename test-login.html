<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Login - Diagn√≥stico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 50px;
            background: #f0f0f0;
        }

        .test-card {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .status.ok {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
        }

        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="test-card">
        <h2>üîç Diagn√≥stico de Login</h2>
        <p class="text-muted">Esta p√°gina te ayudar√° a identificar el problema</p>

        <hr>

        <h5>1. Verificaci√≥n de Carga de Scripts</h5>
        <div id="script-status"></div>

        <h5 class="mt-4">2. Prueba de Login</h5>
        <form id="test-login-form">
            <div class="mb-3">
                <label class="form-label">Email:</label>
                <input type="email" class="form-control" id="test-email" value="test@test.com">
            </div>
            <div class="mb-3">
                <label class="form-label">Password:</label>
                <input type="password" class="form-control" id="test-password" value="test123">
            </div>
            <button type="submit" class="btn btn-primary">Probar Login</button>
        </form>

        <div id="result" class="mt-3"></div>

        <h5 class="mt-4">3. Log de Consola</h5>
        <div id="console-log" class="log"></div>

        <hr>

        <h5>4. Informaci√≥n del Sistema</h5>
        <div id="system-info"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Capturar logs de consola
        const logs = [];
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addLog(type, ...args) {
            const message = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
            logs.push({ type, message, time: new Date().toLocaleTimeString() });
            updateLogDisplay();
        }

        console.log = function (...args) {
            originalLog.apply(console, args);
            addLog('log', ...args);
        };

        console.error = function (...args) {
            originalError.apply(console, args);
            addLog('error', ...args);
        };

        console.warn = function (...args) {
            originalWarn.apply(console, args);
            addLog('warn', ...args);
        };

        function updateLogDisplay() {
            const logDiv = document.getElementById('console-log');
            logDiv.innerHTML = logs.map(l =>
                `<div style="color: ${l.type === 'error' ? 'red' : l.type === 'warn' ? 'orange' : 'black'}">
                    [${l.time}] ${l.type.toUpperCase()}: ${l.message}
                </div>`
            ).join('');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://zczvobqrmucwrbrlksye.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjenZvYnFybXVjd3Jicmxrc3llIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTcyMjAsImV4cCI6MjA4MDYzMzIyMH0.AhRbPtGRUlvW5_Yj-CTKhMFp0w1BvSIUVAO2ucFKbuM';

        let supabase;
        let initAttempts = 0;

        function checkScripts() {
            const statusDiv = document.getElementById('script-status');
            const checks = [];

            // Check 1: Supabase CDN cargado
            if (typeof window.supabase !== 'undefined') {
                checks.push('<div class="status ok">‚úÖ Supabase CDN cargado correctamente</div>');

                // Intentar inicializar
                try {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    checks.push('<div class="status ok">‚úÖ Cliente Supabase inicializado</div>');

                    // Verificar m√©todos
                    if (supabase.auth && supabase.auth.signInWithPassword) {
                        checks.push('<div class="status ok">‚úÖ M√©todo signInWithPassword disponible</div>');
                    } else {
                        checks.push('<div class="status error">‚ùå M√©todo signInWithPassword NO disponible</div>');
                    }
                } catch (error) {
                    checks.push('<div class="status error">‚ùå Error al inicializar: ' + error.message + '</div>');
                }
            } else {
                checks.push('<div class="status error">‚ùå Supabase CDN NO cargado</div>');
                checks.push('<div class="status warning">‚è≥ Reintentando en 1 segundo...</div>');

                initAttempts++;
                if (initAttempts < 10) {
                    setTimeout(checkScripts, 1000);
                }
            }

            statusDiv.innerHTML = checks.join('');
        }

        function showSystemInfo() {
            const infoDiv = document.getElementById('system-info');
            const info = [];

            info.push(`<strong>Navegador:</strong> ${navigator.userAgent}`);
            info.push(`<strong>Fecha/Hora:</strong> ${new Date().toLocaleString()}`);
            info.push(`<strong>URL actual:</strong> ${window.location.href}`);
            info.push(`<strong>Ventana padre:</strong> ${window.parent === window ? 'No (es top)' : 'S√≠ (est√° en iframe)'}`);

            infoDiv.innerHTML = info.join('<br>');
        }

        // Test de login
        document.getElementById('test-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="status warning">‚è≥ Procesando login...</div>';

            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;

            console.log('='.repeat(50));
            console.log('INICIANDO PRUEBA DE LOGIN');
            console.log('Email:', email);
            console.log('Password:', password.replace(/./g, '*'));
            console.log('Supabase existe:', typeof supabase !== 'undefined');

            if (typeof supabase === 'undefined') {
                resultDiv.innerHTML = '<div class="status error">‚ùå Supabase no est√° inicializado</div>';
                console.error('ERROR: Supabase no est√° definido');
                return;
            }

            console.log('Supabase.auth existe:', !!supabase.auth);
            console.log('signInWithPassword existe:', !!supabase.auth?.signInWithPassword);

            try {
                console.log('Llamando a signInWithPassword...');

                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                console.log('Respuesta recibida:', { data, error });

                if (error) {
                    resultDiv.innerHTML = `
                        <div class="status error">
                            <strong>‚ùå Error en Login:</strong><br>
                            Mensaje: ${error.message}<br>
                            C√≥digo: ${error.status || 'N/A'}<br>
                            Tipo: ${error.name || 'N/A'}
                        </div>
                    `;
                    console.error('ERROR DE SUPABASE:', error);
                } else {
                    resultDiv.innerHTML = `
                        <div class="status ok">
                            <strong>‚úÖ Login Exitoso!</strong><br>
                            Usuario: ${data.user.email}<br>
                            ID: ${data.user.id}
                        </div>
                    `;
                    console.log('LOGIN EXITOSO:', data);
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status error">
                        <strong>‚ùå Error de JavaScript:</strong><br>
                        ${error.message}<br>
                        <pre>${error.stack}</pre>
                    </div>
                `;
                console.error('ERROR DE JAVASCRIPT:', error);
            }

            console.log('='.repeat(50));
        });

        // Inicializar
        window.addEventListener('load', () => {
            console.log('P√°gina de diagn√≥stico cargada');
            setTimeout(checkScripts, 500);
            showSystemInfo();
        });
    </script>
</body>

</html>